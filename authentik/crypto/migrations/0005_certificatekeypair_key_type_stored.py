# Generated by Django 5.2.8 on 2025-11-06 21:01

from cryptography.hazmat.backends import default_backend
from cryptography.hazmat.primitives.asymmetric.dsa import DSAPublicKey
from cryptography.hazmat.primitives.asymmetric.ec import EllipticCurvePublicKey
from cryptography.hazmat.primitives.asymmetric.ed448 import Ed448PublicKey
from cryptography.hazmat.primitives.asymmetric.ed25519 import Ed25519PublicKey
from cryptography.hazmat.primitives.asymmetric.rsa import RSAPublicKey
from cryptography.x509 import load_pem_x509_certificate
from django.db import migrations, models


def populate_key_type_stored(apps, schema_editor):  # noqa: ARG001
    """Populate key_type_stored for all existing certificates"""
    CertificateKeyPair = apps.get_model("authentik_crypto", "CertificateKeyPair")

    for cert in CertificateKeyPair.objects.all():
        # Detect key type by parsing the certificate
        key_type = None
        try:
            certificate = load_pem_x509_certificate(
                cert.certificate_data.encode("utf-8"), default_backend()
            )
            public_key = certificate.public_key()

            if isinstance(public_key, RSAPublicKey):
                key_type = "rsa"
            elif isinstance(public_key, EllipticCurvePublicKey):
                key_type = "ec"
            elif isinstance(public_key, DSAPublicKey):
                key_type = "dsa"
            elif isinstance(public_key, Ed25519PublicKey):
                key_type = "ed25519"
            elif isinstance(public_key, Ed448PublicKey):
                key_type = "ed448"
        except (ValueError, TypeError, AttributeError):
            # If we can't parse the certificate, leave key_type_stored as None
            pass

        if key_type:
            cert.key_type_stored = key_type
            cert.save(update_fields=["key_type_stored"])


class Migration(migrations.Migration):

    dependencies = [
        ("authentik_crypto", "0004_alter_certificatekeypair_name"),
    ]

    operations = [
        migrations.AddField(
            model_name="certificatekeypair",
            name="key_type_stored",
            field=models.CharField(
                blank=True,
                choices=[
                    ("rsa", "RSA"),
                    ("ec", "Elliptic Curve"),
                    ("dsa", "DSA"),
                    ("ed25519", "Ed25519"),
                    ("ed448", "Ed448"),
                ],
                help_text="Key algorithm type detected from the certificate's public key",
                max_length=16,
                null=True,
            ),
        ),
        migrations.RunPython(populate_key_type_stored, migrations.RunPython.noop),
    ]
